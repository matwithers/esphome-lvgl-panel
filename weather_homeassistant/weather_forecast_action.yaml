---
# Weather forecast using direct Home Assistant action call
# No template sensor required in HA configuration.yaml!
#
# vars:
#   size: icon size (e.g., 80)
#   weather_entity: weather entity id (default: weather.home)

globals:
  - id: forecast_condition_0
    type: std::string
    initial_value: '"unknown"'
  - id: forecast_condition_1
    type: std::string
    initial_value: '"unknown"'
  - id: forecast_condition_2
    type: std::string
    initial_value: '"unknown"'
  - id: forecast_condition_3
    type: std::string
    initial_value: '"unknown"'

# Fetch weather on startup and every hour
time:
  - platform: homeassistant
    on_time:
      - hours: '*'
        minutes: 0
        seconds: 30
        then:
          - script.execute: fetch_weather_forecast

api:
  on_client_connected:
    - delay: 3s
    - script.execute: fetch_weather_forecast


script:
  - id: fetch_weather_forecast
    then:
      - logger.log:
          level: INFO
          format: "Requesting weather forecast from Home Assistant..."
      - homeassistant.action:
          action: weather.get_forecasts
          data:
            type: daily
            entity_id: ${weather_entity | default("weather.home")}
          capture_response: true
          response_template: >-
            {% set forecasts = response["${weather_entity | default('weather.home')}"].forecast %}
            {% set result = {
              'condition_0': forecasts[0].condition | default('unknown'),
              'temp_hi_0': forecasts[0].temperature | default(0) | string,
              'temp_lo_0': forecasts[0].templow | default(0) | string,
              'day_0': as_timestamp(forecasts[0].datetime) | timestamp_custom('%a'),
              'condition_1': forecasts[1].condition | default('unknown'),
              'temp_hi_1': forecasts[1].temperature | default(0) | string,
              'temp_lo_1': forecasts[1].templow | default(0) | string,
              'day_1': as_timestamp(forecasts[1].datetime) | timestamp_custom('%a'),
              'condition_2': forecasts[2].condition | default('unknown'),
              'temp_hi_2': forecasts[2].temperature | default(0) | string,
              'temp_lo_2': forecasts[2].templow | default(0) | string,
              'day_2': as_timestamp(forecasts[2].datetime) | timestamp_custom('%a'),
              'condition_3': forecasts[3].condition | default('unknown'),
              'temp_hi_3': forecasts[3].temperature | default(0) | string,
              'temp_lo_3': forecasts[3].templow | default(0) | string,
              'day_3': as_timestamp(forecasts[3].datetime) | timestamp_custom('%a')
            } %}
            {{ result | tojson }}
          on_success:
            - lambda: |-
                auto data = response["response"];

                // Store conditions in globals for icon updates
                id(forecast_condition_0) = data["condition_0"].as<std::string>();
                id(forecast_condition_1) = data["condition_1"].as<std::string>();
                id(forecast_condition_2) = data["condition_2"].as<std::string>();
                id(forecast_condition_3) = data["condition_3"].as<std::string>();

                ESP_LOGI("weather", "Day 0: %s, Hi: %s, Lo: %s",
                    data["day_0"].as<std::string>().c_str(),
                    data["temp_hi_0"].as<std::string>().c_str(),
                    data["temp_lo_0"].as<std::string>().c_str());

            # Update Day 0
            - lvgl.label.update:
                id: forecast_day_0
                text: !lambda 'return response["response"]["day_0"].as<std::string>();'
            - lvgl.label.update:
                id: forecast_temperature_hi_0
                text: !lambda |-
                  float t = atof(response["response"]["temp_hi_0"].as<std::string>().c_str());
                  int ti = (int) lroundf(t);
                  char buf[8];
                  snprintf(buf, sizeof(buf), "%d°", ti);
                  return std::string(buf);
            - lvgl.label.update:
                id: forecast_temperature_lo_0
                text: !lambda |-
                  float t = atof(response["response"]["temp_lo_0"].as<std::string>().c_str());
                  int ti = (int) lroundf(t);
                  char buf[8];
                  snprintf(buf, sizeof(buf), "%d°", ti);
                  return std::string(buf);
            - script.execute: update_forecast_icon_0

            # Update Day 1
            - lvgl.label.update:
                id: forecast_day_1
                text: !lambda 'return response["response"]["day_1"].as<std::string>();'
            - lvgl.label.update:
                id: forecast_temperature_hi_1
                text: !lambda |-
                  float t = atof(response["response"]["temp_hi_1"].as<std::string>().c_str());
                  int ti = (int) lroundf(t);
                  char buf[8];
                  snprintf(buf, sizeof(buf), "%d°", ti);
                  return std::string(buf);
            - lvgl.label.update:
                id: forecast_temperature_lo_1
                text: !lambda |-
                  float t = atof(response["response"]["temp_lo_1"].as<std::string>().c_str());
                  int ti = (int) lroundf(t);
                  char buf[8];
                  snprintf(buf, sizeof(buf), "%d°", ti);
                  return std::string(buf);
            - script.execute: update_forecast_icon_1

            # Update Day 2
            - lvgl.label.update:
                id: forecast_day_2
                text: !lambda 'return response["response"]["day_2"].as<std::string>();'
            - lvgl.label.update:
                id: forecast_temperature_hi_2
                text: !lambda |-
                  float t = atof(response["response"]["temp_hi_2"].as<std::string>().c_str());
                  int ti = (int) lroundf(t);
                  char buf[8];
                  snprintf(buf, sizeof(buf), "%d°", ti);
                  return std::string(buf);
            - lvgl.label.update:
                id: forecast_temperature_lo_2
                text: !lambda |-
                  float t = atof(response["response"]["temp_lo_2"].as<std::string>().c_str());
                  int ti = (int) lroundf(t);
                  char buf[8];
                  snprintf(buf, sizeof(buf), "%d°", ti);
                  return std::string(buf);
            - script.execute: update_forecast_icon_2

            # Update Day 3
            - lvgl.label.update:
                id: forecast_day_3
                text: !lambda 'return response["response"]["day_3"].as<std::string>();'
            - lvgl.label.update:
                id: forecast_temperature_hi_3
                text: !lambda |-
                  float t = atof(response["response"]["temp_hi_3"].as<std::string>().c_str());
                  int ti = (int) lroundf(t);
                  char buf[8];
                  snprintf(buf, sizeof(buf), "%d°", ti);
                  return std::string(buf);
            - lvgl.label.update:
                id: forecast_temperature_lo_3
                text: !lambda |-
                  float t = atof(response["response"]["temp_lo_3"].as<std::string>().c_str());
                  int ti = (int) lroundf(t);
                  char buf[8];
                  snprintf(buf, sizeof(buf), "%d°", ti);
                  return std::string(buf);
            - script.execute: update_forecast_icon_3

          on_error:
            - logger.log:
                level: ERROR
                format: "Failed to fetch weather forecast from Home Assistant"

  # Icon update scripts - these read from the globals
  - id: update_forecast_icon_0
    then:
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "clear-night";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'clear_night_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "cloudy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'cloudy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "exceptional";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'exceptional_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "fog";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'fog_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "hail";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'hail_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "lightning";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'lightning_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "lightning-rainy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'lightning_rainy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "partlycloudy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'partlycloudy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "pouring";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'pouring_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "rainy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'rainy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "snowy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'snowy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "snowy-rainy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'snowy_rainy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "sunny";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'sunny_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "windy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'windy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_0) == "windy-variant";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_0
              src: 'windy_${size}'

  - id: update_forecast_icon_1
    then:
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "clear-night";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'clear_night_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "cloudy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'cloudy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "exceptional";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'exceptional_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "fog";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'fog_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "hail";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'hail_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "lightning";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'lightning_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "lightning-rainy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'lightning_rainy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "partlycloudy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'partlycloudy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "pouring";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'pouring_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "rainy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'rainy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "snowy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'snowy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "snowy-rainy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'snowy_rainy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "sunny";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'sunny_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "windy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'windy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_1) == "windy-variant";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_1
              src: 'windy_${size}'

  - id: update_forecast_icon_2
    then:
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "clear-night";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'clear_night_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "cloudy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'cloudy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "exceptional";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'exceptional_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "fog";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'fog_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "hail";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'hail_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "lightning";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'lightning_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "lightning-rainy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'lightning_rainy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "partlycloudy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'partlycloudy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "pouring";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'pouring_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "rainy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'rainy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "snowy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'snowy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "snowy-rainy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'snowy_rainy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "sunny";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'sunny_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "windy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'windy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_2) == "windy-variant";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_2
              src: 'windy_${size}'

  - id: update_forecast_icon_3
    then:
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "clear-night";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'clear_night_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "cloudy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'cloudy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "exceptional";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'exceptional_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "fog";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'fog_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "hail";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'hail_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "lightning";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'lightning_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "lightning-rainy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'lightning_rainy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "partlycloudy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'partlycloudy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "pouring";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'pouring_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "rainy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'rainy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "snowy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'snowy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "snowy-rainy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'snowy_rainy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "sunny";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'sunny_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "windy";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'windy_${size}'
      - if:
          condition:
            lambda: 'return id(forecast_condition_3) == "windy-variant";'
          then:
            lvgl.image.update:
              id: forecast_condition_icon_3
              src: 'windy_${size}'


# Weather icons - included automatically
image:
  rgb565:
    alpha_channel:
      - file: esphome-lvgl-panel/modules/weather/assets/images/wi-night-clear.svg
        id: clear_night_${size}
        resize: ${size}x${size}

      - file: esphome-lvgl-panel/modules/weather/assets/images/wi-cloudy.svg
        id: cloudy_${size}
        resize: ${size}x${size}

      - file: esphome-modular-lvgl-buttons/weather_homeassistant/assets/images/tstorms.svg
        id: exceptional_${size}
        resize: ${size}x${size}

      - file: esphome-modular-lvgl-buttons/weather_homeassistant/assets/images/fog.svg
        id: fog_${size}
        resize: ${size}x${size}

      - file: esphome-modular-lvgl-buttons/weather_homeassistant/assets/images/sleet.svg
        id: hail_${size}
        resize: ${size}x${size}

      - file: esphome-modular-lvgl-buttons/weather_homeassistant/assets/images/chancetstorms.svg
        id: lightning_${size}
        resize: ${size}x${size}

      - file: esphome-modular-lvgl-buttons/weather_homeassistant/assets/images/tstorms.svg
        id: lightning_rainy_${size}
        resize: ${size}x${size}

      - file: esphome-lvgl-panel/modules/weather/assets/images/wi-day-cloudy.svg
        id: partlycloudy_${size}
        resize: ${size}x${size}

      - file: esphome-lvgl-panel/modules/weather/assets/images/wi-rain.svg
        id: pouring_${size}
        resize: ${size}x${size}

      - file: esphome-lvgl-panel/modules/weather/assets/images/wi-showers.svg
        id: rainy_${size}
        resize: ${size}x${size}

      - file: esphome-modular-lvgl-buttons/weather_homeassistant/assets/images/snow.svg
        id: snowy_${size}
        resize: ${size}x${size}

      - file: esphome-modular-lvgl-buttons/weather_homeassistant/assets/images/chancesleet.svg
        id: snowy_rainy_${size}
        resize: ${size}x${size}

      - file: esphome-lvgl-panel/modules/weather/assets/images/wi-day-sunny.svg
        id: sunny_${size}
        resize: ${size}x${size}

      - file: esphome-modular-lvgl-buttons/weather_homeassistant/assets/images/windy.svg
        id: windy_${size}
        resize: ${size}x${size}

      - file: esphome-modular-lvgl-buttons/weather_homeassistant/assets/images/unknown.svg
        id: unknown_${size}
        resize: ${size}x${size}

      - file: esphome-modular-lvgl-buttons/weather_homeassistant/assets/images/circle-slash.svg
        id: unavailable_${size}
        resize: ${size}x${size}
