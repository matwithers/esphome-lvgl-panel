---
# Substitution variables used through the codebase
substitutions:
  icon_font: mdi_icons_40
  text_font: font_body_20
  text_color: color_primary_text
  bg_color: color_background
  button_on_color: color_accent
  button_off_color: color_outline
  icon_on_color: color_accent
  icon_off_color: color_secondary_text
  label_on_color: color_primary_text
  label_off_color: color_secondary_text
  button_text_color: color_primary_text

  # LCD back light modes - Code in backlight_time.yaml
  # Set Day mode - starts at Sunrise - screen at 100%
  touchscreen_daytime_brightness: "100%"
  # Set Evening mode -  starts at Sunset - screen at 50% (may need to be brighter for some screens)
  touchscreen_nighttime_brightness: "50%"
  # Set Night mode start time (default is midnight)
  touchscreen_night_hour: "0"      # Hour for night mode (0-23)
  touchscreen_night_minute: "0"    # Minute for night mode (0-59)
  # Set touchscreen idle timeout - In night mode back light goes off after this amount of time
  touchscreen_idle_timeout: "60s"
  # Screen Size
  screen_height: '480'
  screen_width: '480'


esphome:
  name: "guition-4848s040"
  friendly_name: "Guition 4848s040"
  comment: "Guition ESP32-S3-4848S040 480px * 480px Smart Screen"
  on_boot:
    - priority: 400
      then:
        - script.execute: update_loading_page
ota:
  - platform: esphome

logger:
  level: DEBUG

api:
  on_client_connected:
    - script.execute: time_update

time:
  - platform: homeassistant
    id: system_time

packages:
  # Generic configuration for ESP32 screens
  # All the colors
  colors: !include esphome-lvgl-panel/common/palette_dark.yaml
  # Fonts you need
  fonts: !include esphome-lvgl-panel/common/fonts.yaml
  # 1000s of glyphs
  glyphs: !include esphome-modular-lvgl-buttons/common/mdi_glyph_substitutions.yaml
  # SDL has no Wi-Fi wifi: 
  wifi: !include esphome-modular-lvgl-buttons/common/wifi.yaml
  # Some basic sensors
  #sensors: !include esphome-modular-lvgl-buttons/sensors/sensors_base-SDL.yaml
  sensors: !include esphome-modular-lvgl-buttons/sensors/sensors_base.yaml
  # Styles + Themes
  # theme_style: !include esphome-modular-lvgl-buttons/common/theme_style_debug.yaml
  theme_style: !include esphome-modular-lvgl-buttons/common/theme_style.yaml

  # Harware description file
  #hardware: !include esphome-modular-lvgl-buttons/hardware/SDL-lvgl.yaml
  hardware: !include esphome-modular-lvgl-buttons/hardware/guition-esp32-s3-4848s040.yaml

  # Basic boot screen with ESPHome logo and device diagnostic info
  loading_screen: !include esphome-lvgl-panel/pages/loading_480px.yaml
  info_screen: !include esphome-lvgl-panel/pages/info.yaml

  # Weather packages
  # Display weather forecast using direct HA action (no template sensor needed!)
  # Icons are included automatically in the action file
  weather_forecast_80: !include
    file: esphome-lvgl-panel/weather_homeassistant/weather_forecast_action.yaml
    vars:
      size: 80
      weather_entity: weather.met_office_totton
  # Get todays weather and display it (icons included automatically)
  weather_today_200: !include
    file: esphome-lvgl-panel/weather_homeassistant/weather_today.yaml
    vars:
      size: 80
      weather_entity: weather.met_office_totton
      weather_summary: sensor.home_hourly_summary

# Styles for Weather forecast
.forecast_styles:
  - &now_forecast_obj_base
    width: 100%
    height: SIZE_CONTENT
    bg_color: color_background
    radius: 3
    pad_top: 2
    pad_bottom: 2
    layout:
      type: flex
      flex_flow: COLUMN
      flex_align_cross: center
      flex_align_track: center
      pad_column: 0
      pad_row: 2

  - &forecast_obj_base
    height: SIZE_CONTENT
    width: SIZE_CONTENT
    bg_color: color_surface
    radius: 3
    pad_top: 2
    pad_bottom: 2
    layout:
      type: flex
      flex_flow: COLUMN
      flex_align_cross: center
      flex_align_track: center
      pad_column: 0
      pad_row: 2

  - &forecast_label_base
    text_font: font_body_24
    height: SIZE_CONTENT

  - &forecast_label_base_lo
    height: SIZE_CONTENT
    text_font: font_body_20
    text_color: dodgerblue

  - &forecast_image_base
    height: SIZE_CONTENT

script:
  - id: time_update
    then:
      - lvgl.label.update:
          id: current_time
          text: !lambda 'return id(system_time).now().strftime("%H:%M");'  # 12-hour format, no am/pm
      - lvgl.label.update:
          id: month_day
          text: !lambda |- # Month Day
            auto time = id(system_time).now();
            int day = time.day_of_month;
            char strftime_buf[64];
            snprintf(strftime_buf, sizeof(strftime_buf), "%s %d", time.strftime("%B").c_str(), day);
            return {strftime_buf};

text_sensor:
  - platform: homeassistant
    entity_id: sensor.leaf_battery_level
    id: leaf_battery_level
    on_value:
      then:
        - lvgl.label.update:
            id: ev_battery_level
            text:
              format: "%s%%"
              args: ['id(leaf_battery_level).state.c_str()']

  - platform: homeassistant
    entity_id: sensor.leaf_range_ac_off
    id: leaf_range
    on_value:
      then:
      - lvgl.label.update:
          id: ev_range
          text: !lambda |-
            float range = atof(id(leaf_range).state.c_str());
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mi", range);
            return std::string(buf);

image:
  rgb565:
    alpha_channel:
      - file: esphome-lvgl-panel/assets/images/car_outline_dark.svg
        id: car_outline_dark_200
        resize: 200x200

lvgl:
  pages:
    - id: main_page
      layout: 9x4
      styles: page_style
      <<: !include esphome-modular-lvgl-buttons/widgets/swipe_navigation.yaml
      bg_color: color_background
      widgets:
        - container:
            grid_cell_x_align: stretch
            grid_cell_y_align: stretch
            grid_cell_row_pos: 0
            grid_cell_column_pos: 0
            grid_cell_row_span: 3
            grid_cell_column_span: 2
            layout:
              type: flex
              flex_flow: COLUMN
              flex_align_main: center
              flex_align_cross: center
              pad_row: 2
            widgets:
              - label:
                  id: current_time
                  width: 100%
                  text_align: center
                  text_font: font_display_72
                  pad_bottom: -6   # <-- key adjustment
              - label:
                  id: month_day
                  width: 100%
                  text_align: center
                  text_font: font_body_24

        - container:
            grid_cell_x_align: stretch
            grid_cell_y_align: stretch
            grid_cell_row_pos: 0
            grid_cell_column_pos: 2
            grid_cell_row_span: 3
            grid_cell_column_span: 2
            layout:
              type: flex
              flex_flow: COLUMN
              flex_align_main: center
              flex_align_cross: center
              pad_row: 2
            widgets:
              - label:
                  text: "EV"
                  text_font: font_body_20
              - label:
                  id: ev_battery_level
                  text: "--%"
                  text_font: font_display_48
              - label:
                  id: ev_range
                  text: "-- mi"
                  text_font: font_body_24

        - container:
            grid_cell_x_align: stretch
            grid_cell_y_align: stretch
            grid_cell_row_pos: 3
            grid_cell_column_pos: 0
            grid_cell_row_span: 3
            grid_cell_column_span: 2
            #outline_width: 1   # debug
            #outline_color: red # debug
            widgets:
              - obj:
                  <<: *now_forecast_obj_base
                  widgets:
                    - label:
                        text: "Now"
                        <<: *forecast_label_base
                    - image:
                        id: weather_condition_icon
                        src: unknown_80
                    - label:
                        id: weather_temperature_today
                        <<: *forecast_label_base
                        text: "---°"
        - container:
            grid_cell_x_align: stretch
            grid_cell_y_align: stretch
            grid_cell_row_pos: 3
            grid_cell_column_pos: 2
            grid_cell_row_span: 3
            grid_cell_column_span: 2
            #outline_width: 1   # debug
            #outline_color: red # debug
            widgets:
              - image:
                  src: car_outline_dark_200

        - container:
            grid_cell_x_align: stretch
            grid_cell_y_align: stretch
            grid_cell_row_pos: 6
            grid_cell_column_pos: 0
            grid_cell_row_span: 3
            grid_cell_column_span: 4
            #outline_width: 1   # debug code - This is for visualizing boundries remove for production
            #outline_color: red # debug code - This is for visualizing boundries remove for production
            layout: 1x4
            widgets:
              - obj:
                  <<: *forecast_obj_base
                  grid_cell_row_pos: 0
                  grid_cell_column_pos: 0
                  widgets:
                    - label:
                        id: forecast_day_0
                        <<: *forecast_label_base
                        text: ???
                    - image:
                        id: forecast_condition_icon_0
                        <<: *forecast_label_base
                        src: unknown_80
                    - container:
                        width: SIZE_CONTENT
                        height: SIZE_CONTENT
                        layout:
                          type: flex
                          flex_flow: ROW
                          flex_align_cross: center
                          pad_column: 4
                        widgets:
                          - label:
                              id: forecast_temperature_hi_0
                              <<: *forecast_label_base
                              text: "---°"
                          - label:
                              text: "/"
                              <<: *forecast_label_base
                          - label:
                              id: forecast_temperature_lo_0
                              <<: *forecast_label_base_lo
                              text: "---°"
              - obj:
                  <<: *forecast_obj_base
                  grid_cell_row_pos: 0
                  grid_cell_column_pos: 1
                  widgets:
                    - label:
                        id: forecast_day_1
                        <<: *forecast_label_base
                        text: ???
                    - image:
                        id: forecast_condition_icon_1
                        <<: *forecast_label_base
                        src: unknown_80
                    - container:
                        width: SIZE_CONTENT
                        height: SIZE_CONTENT
                        layout:
                          type: flex
                          flex_flow: ROW
                          flex_align_cross: center
                          pad_column: 4
                        widgets:
                          - label:
                              id: forecast_temperature_hi_1
                              <<: *forecast_label_base
                              text: "---°"
                          - label:
                              text: "/"
                              <<: *forecast_label_base
                          - label:
                              id: forecast_temperature_lo_1
                              <<: *forecast_label_base_lo
                              text: "---°"
              - obj:
                  <<: *forecast_obj_base
                  grid_cell_row_pos: 0
                  grid_cell_column_pos: 2
                  widgets:
                    - label:
                        id: forecast_day_2
                        <<: *forecast_label_base
                        text: ???
                    - image:
                        id: forecast_condition_icon_2
                        <<: *forecast_label_base
                        src: unknown_80
                    - container:
                        width: SIZE_CONTENT
                        height: SIZE_CONTENT
                        layout:
                          type: flex
                          flex_flow: ROW
                          flex_align_cross: center
                          pad_column: 4
                        widgets:
                          - label:
                              id: forecast_temperature_hi_2
                              <<: *forecast_label_base
                              text: "---°"
                          - label:
                              text: "/"
                              <<: *forecast_label_base
                          - label:
                              id: forecast_temperature_lo_2
                              <<: *forecast_label_base_lo
                              text: "---°"
              - obj:
                  <<: *forecast_obj_base
                  grid_cell_row_pos: 0
                  grid_cell_column_pos: 3
                  widgets:
                    - label:
                        id: forecast_day_3
                        <<: *forecast_label_base
                        text: ???
                    - image:
                        id: forecast_condition_icon_3
                        <<: *forecast_label_base
                        src: unknown_80
                    - container:
                        width: SIZE_CONTENT
                        height: SIZE_CONTENT
                        layout:
                          type: flex
                          flex_flow: ROW
                          flex_align_cross: center
                          pad_column: 4
                        widgets:
                          - label:
                              id: forecast_temperature_hi_3
                              <<: *forecast_label_base
                              text: "---°"
                          - label:
                              text: "/"
                              <<: *forecast_label_base
                          - label:
                              id: forecast_temperature_lo_3
                              <<: *forecast_label_base_lo
                              text: "---°"