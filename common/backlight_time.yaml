---
# ═══════════════════════════════════════════════════════════════════════════════
# BACKLIGHT TIME CONTROL
# ═══════════════════════════════════════════════════════════════════════════════
# Controls display brightness based on sun position and time of day.
#
# Required substitutions:
#   touchscreen_daytime_brightness: "100%"
#   touchscreen_nighttime_brightness: "50%"
#   touchscreen_idle_timeout: "30s"
#   touchscreen_night_hour: "0"      # Hour for night mode (0-23)
#   touchscreen_night_minute: "0"    # Minute for night mode (0-59)
#
# Modes:
#   Day     - After sunrise, full brightness
#   Evening - After sunset, reduced brightness
#   Night   - After night hour, screen off when idle
# ═══════════════════════════════════════════════════════════════════════════════

sun:
  latitude: !secret latitude
  longitude: !secret longitude
  on_sunset:
    - elevation: -3.5°
      then:
        - select.set:
            id: brightness_mode
            option: "Evening"
  on_sunrise:
    - then:
        - select.set:
            id: brightness_mode
            option: "Day"

time:
  - platform: homeassistant
    id: system_time
    on_time_sync:
      - script.execute: time_update

      # Always decide the correct mode on boot/sync
      - logger.log:
          level: INFO
          format: "Setting brightness mode on boot"
      - script.execute: set_brightness_mode_on_boot
      - script.execute: apply_brightness_mode   # optional but recommended

      # Update last restart time (only once)
      - if:
          condition:
            lambda: 'return id(device_last_restart).state == "";'
          then:
            - text_sensor.template.publish:
                id: device_last_restart
                state: !lambda 'return id(system_time).now().strftime("%a %d %b %Y - %I:%M:%S %p");'
          #  - logger.log:
          #      level: INFO
          #      format: "Setting brightness mode on boot"
          #  - script.execute: set_brightness_mode_on_boot

    on_time:
      # Trigger night mode at configured time
      - seconds: 0
        minutes: ${touchscreen_night_minute}
        hours: ${touchscreen_night_hour}
        then:
          - select.set:
              id: brightness_mode
              option: "Night"
      # Update time display every minute
      - seconds: 0
        minutes: '*'
        then:
          - script.execute: time_update

lvgl:
  on_idle:
    timeout: ${touchscreen_idle_timeout}
    then:
      - logger.log:
          level: INFO
          format: "LVGL is idle"
      - if:
          condition:
            lambda: 'return id(brightness_mode).current_option() == "Day";'
          then:
            - light.turn_on:
                id: display_backlight
                brightness: ${touchscreen_daytime_brightness}
      - if:
          condition:
            lambda: 'return id(brightness_mode).current_option() == "Evening";'
          then:
            - light.turn_on:
                id: display_backlight
                brightness: ${touchscreen_nighttime_brightness}
      - if:
          condition:
            lambda: 'return id(brightness_mode).current_option() == "Night";'
          then:
            - light.turn_off: display_backlight
            - lvgl.pause:
                show_snow: true

# Wake on screen touch - extends the touchscreen defined in hardware file
touchscreen:
  - id: !extend my_touchscreen
    on_touch:
      then:
        - logger.log:
            level: INFO
            format: "LVGL is active"
        - lvgl.resume
        - lvgl.widget.redraw
        - script.execute: apply_brightness_mode

select:
  - platform: template
    name: "Brightness mode"
    id: brightness_mode
    icon: mdi:television-shimmer
    optimistic: true
    options:
      - Day
      - Evening
      - Night
    initial_option: Day
    on_value:
      then:
        - lvgl.resume
        - lvgl.widget.redraw
        - script.execute: apply_brightness_mode

script:
  # ─────────────────────────────────────────────────────────────────────────────
  # Apply brightness based on current mode
  # ─────────────────────────────────────────────────────────────────────────────
  - id: apply_brightness_mode
    then:
      - if:
          condition:
            lambda: 'return id(brightness_mode).current_option() == "Day";'
          then:
            - light.turn_on:
                id: display_backlight
                brightness: ${touchscreen_daytime_brightness}
      - if:
          condition:
            lambda: 'return id(brightness_mode).current_option() == "Evening";'
          then:
            - light.turn_on:
                id: display_backlight
                brightness: ${touchscreen_nighttime_brightness}
      - if:
          condition:
            lambda: 'return id(brightness_mode).current_option() == "Night";'
          then:
            - light.turn_on:
                id: display_backlight
                brightness: ${touchscreen_nighttime_brightness}

  # ─────────────────────────────────────────────────────────────────────────────
  # Set brightness mode on boot based on sun position and time
  # Logic:
  #   - Sun above horizon → Day
  #   - Sun below horizon + time >= night_hour → Night
  #   - Sun below horizon + time < night_hour → Evening
  # Note: Early morning (before sunrise) sun is down, but we've already passed
  #       night_hour from the previous day, so it remains Night until sunrise.
  # ─────────────────────────────────────────────────────────────────────────────
  - id: set_brightness_mode_on_boot
    then:
      - if:
          condition:
            sun.is_above_horizon:
          then:
            - logger.log:
                level: INFO
                format: "Boot: Sun is up - Day mode"
            - select.set:
                id: brightness_mode
                option: "Day"
          else:
            # Sun is down - determine Evening vs Night based on time
            - if:
                condition:
                  lambda: |-
                    auto now = id(system_time).now();
                    int current = now.hour * 60 + now.minute;
                    int night = ${touchscreen_night_hour} * 60 + ${touchscreen_night_minute};
                    // Special case: if night_hour is midnight (0), use AM/PM as divider
                    // Evening = PM hours (12-23), Night = AM hours (0-11)
                    if (night == 0) {
                      return now.hour < 12;
                    }
                    // Otherwise: Night if past night_hour OR early morning (crossed midnight)
                    return current >= night || now.hour < 12;
                then:
                  - logger.log:
                      level: INFO
                      format: "Boot: Night mode"
                  - select.set:
                      id: brightness_mode
                      option: "Night"
                else:
                  - logger.log:
                      level: INFO
                      format: "Boot: Evening mode"
                  - select.set:
                      id: brightness_mode
                      option: "Evening"
